<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é£¢é¤“æ™‚åˆ» ğŸœ</title>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Maps API with Places Library -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBrYfdP4HoPDf6dxUN9f-2MesaUBNSv8FQ&libraries=places"></script>
    <style>
        /* Font Setup */
        body {
            font-family: 'Montserrat', sans-serif;
        }
        
        h1, h2, h3 {
            font-family: 'Playfair Display', serif;
        }
        
        /* è‡ªè¨‚æ¨£å¼ - è®“æœå°‹æ¡†èˆ‡ Google Places Autocomplete æ•´åˆæ›´å¥½çœ‹ */
        .pac-container {
            border-radius: 0.5rem;
            margin-top: 0.25rem;
            box-shadow: 0 10px 15px -3px rgba(217, 119, 6, 0.3);
            background-color: #1f2937;
            border: 1px solid rgba(251, 191, 36, 0.3);
        }
        
        .pac-item {
            background-color: #1f2937;
            color: #e5e7eb;
            border-top: 1px solid rgba(251, 191, 36, 0.1);
            padding: 8px;
        }
        
        .pac-item:hover {
            background-color: #374151;
        }
        
        .pac-item-query {
            color: #fbbf24;
        }
        
        /* æ˜Ÿæ˜Ÿåœ–ç¤º - é‡‘è‰² */
        .star {
            color: #fbbf24;
        }
        
        /* Loading å‹•ç•« */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .spinner {
            animation: spin 1s linear infinite;
        }
        
        /* å¹³æ»‘æ»¾å‹• */
        html {
            scroll-behavior: smooth;
        }
        
        /* Hero Background Overlay */
        .hero-overlay {
            background: linear-gradient(to bottom, rgba(0, 0, 0, 0.75), rgba(17, 24, 39, 0.9));
        }
        
        /* è½‰ç›¤å‹•ç•« */
        @keyframes wheelSpin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(var(--spin-rotation, 1800deg)); }
        }
        
        .wheel-spinning {
            animation: wheelSpin 2s cubic-bezier(0.33, 0.01, 0.67, 1);
        }
        
        /* æ¨¡æ…‹æ¡†èƒŒæ™¯ */
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
        }
        
        /* è½‰ç›¤å®¹å™¨ */
        .wheel-container {
            width: 400px;
            height: 400px;
            border-radius: 50%;
            position: relative;
            box-shadow: 0 0 60px rgba(217, 119, 6, 0.6);
            background: #1f2937;
            border: 3px solid #d97706;
        }
        
        /* SVG è½‰ç›¤ */
        #wheel-svg {
            width: 100%;
            height: 100%;
        }
        
        .wheel-text {
            font-size: 13px;
            font-weight: bold;
            fill: white;
            pointer-events: none;
            text-anchor: middle;
            filter: drop-shadow(1px 1px 2px rgba(0,0,0,0.8));
            writing-mode: vertical-rl;
            letter-spacing: 2px;
        }
        
        /* æŒ‡é‡ */
        .wheel-pointer {
            width: 0;
            height: 0;
            border-left: 20px solid transparent;
            border-right: 20px solid transparent;
            border-top: 35px solid #fbbf24;
            position: absolute;
            top: -35px;
            left: 50%;
            transform: translateX(-50%);
            filter: drop-shadow(0 4px 6px rgba(251, 191, 36, 0.5));
            z-index: 20;
        }
        
        /* Gold gradient button effect */
        .btn-gold {
            background: linear-gradient(135deg, #d97706 0%, #fbbf24 50%, #d97706 100%);
            background-size: 200% auto;
            transition: all 0.3s ease;
        }
        
        .btn-gold:hover {
            background-position: right center;
            box-shadow: 0 0 20px rgba(251, 191, 36, 0.5);
        }
    </style>
</head>
<body class="bg-slate-950 min-h-screen">
    
    <!-- ä¸»å®¹å™¨ -->
    <div class="container mx-auto px-4 py-6 md:py-10 max-w-7xl">
        
        <!-- Hero Banner with Background -->
        <header class="relative mb-8 md:mb-12 -mx-4 px-4">
            <!-- Background Image with Dark Overlay -->
            <div class="relative rounded-2xl overflow-hidden">
                <!-- Using a dark fine dining themed background with overlay -->
                <div class="absolute inset-0 bg-gradient-to-br from-gray-900 via-slate-800 to-gray-900"></div>
                <div class="absolute inset-0 hero-overlay"></div>
                
                <!-- Content -->
                <div class="relative text-center py-16 md:py-24 px-6">
                    <h1 class="text-4xl md:text-6xl lg:text-7xl font-bold text-amber-400 mb-4 tracking-wide">
                        é£¢é¤“é£Ÿåˆ»
                    </h1>
                   
                </div>
            </div>
        </header>

        <!-- æœå°‹æ§åˆ¶å€åŸŸ -->
        <div class="bg-gray-900 rounded-2xl shadow-2xl border border-amber-500/30 p-6 md:p-8 mb-8">
            
            <!-- Mobile: å‚ç›´å †ç–Š / Desktop: æ°´å¹³æ’åˆ— -->
            <div class="flex flex-col md:flex-row md:items-end gap-4 md:gap-6">
                
                <!-- ä½ç½®æœå°‹æ¡† -->
                <div class="flex-1">
                    <label for="location-input" class="block text-sm font-semibold text-amber-400 mb-2 tracking-wide">
                        ğŸ“ è«‹è¼¸å…¥åœ°é»
                    </label>
                    <input 
                        type="text" 
                        id="location-input" 
                        placeholder="ä¾‹å¦‚ï¼šå°åŒ— 101" 
                        class="w-full px-4 py-3 bg-gray-800 border-2 border-amber-500/50 text-gray-200 placeholder-gray-500 rounded-lg focus:outline-none focus:border-amber-400 focus:ring-2 focus:ring-amber-400/30 transition-all"
                    />
                </div>

                <!-- æœ€ä½è©•åˆ†æ»‘æ¡¿ -->
                <div class="flex-1">
                    <label for="rating-slider" class="block text-sm font-semibold text-amber-400 mb-2 tracking-wide">
                        â­ æœ€ä½è©•åˆ†: <span id="rating-value" class="text-amber-300">4.0</span>
                    </label>
                    <input 
                        type="range" 
                        id="rating-slider" 
                        min="0" 
                        max="5" 
                        step="0.5" 
                        value="4.0" 
                        class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-amber-500"
                    />
                </div>

                <!-- åƒ¹æ ¼ç­‰ç´šé¸æ“‡ -->
                <div class="flex-1">
                    <label class="block text-sm font-semibold text-amber-400 mb-2 tracking-wide">
                        ğŸ’° åƒ¹æ ¼ç­‰ç´š
                    </label>
                    <div class="flex gap-2">
                        <button class="price-btn flex-1 px-3 py-2 border-2 border-amber-500/50 bg-gray-800 rounded-lg text-gray-300 hover:bg-gray-700 hover:border-amber-400 transition-all" data-price="1">$</button>
                        <button class="price-btn flex-1 px-3 py-2 border-2 border-amber-500/50 bg-gray-800 rounded-lg text-gray-300 hover:bg-gray-700 hover:border-amber-400 transition-all" data-price="2">$$</button>
                        <button class="price-btn flex-1 px-3 py-2 border-2 border-amber-500/50 bg-gray-800 rounded-lg text-gray-300 hover:bg-gray-700 hover:border-amber-400 transition-all" data-price="3">$$$</button>
                        <button class="price-btn flex-1 px-3 py-2 border-2 border-amber-500/50 bg-gray-800 rounded-lg text-gray-300 hover:bg-gray-700 hover:border-amber-400 transition-all" data-price="4">$$$$</button>
                    </div>
                </div>
            </div>
            
            <!-- é¤å»³é¡åˆ¥é¸æ“‡ (ç¬¬äºŒæ’) -->
            <div class="mt-4">
                <label class="block text-sm font-semibold text-amber-400 mb-2 tracking-wide">
                    ğŸ½ï¸ é¤å»³é¡åˆ¥
                </label>
                <div class="flex flex-wrap gap-2">
                    <button class="cuisine-btn px-4 py-2 border-2 border-amber-500/50 bg-gray-800 rounded-lg text-gray-300 hover:bg-gray-700 hover:border-amber-400 transition-all" data-cuisine="japanese">ğŸ± æ—¥å¼</button>
                    <button class="cuisine-btn px-4 py-2 border-2 border-amber-500/50 bg-gray-800 rounded-lg text-gray-300 hover:bg-gray-700 hover:border-amber-400 transition-all" data-cuisine="italian">ğŸ• ç¾©å¼</button>
                    <button class="cuisine-btn px-4 py-2 border-2 border-amber-500/50 bg-gray-800 rounded-lg text-gray-300 hover:bg-gray-700 hover:border-amber-400 transition-all" data-cuisine="korean">ğŸ¥˜ éŸ“å¼</button>
                    <button class="cuisine-btn px-4 py-2 border-2 border-amber-500/50 bg-gray-800 rounded-lg text-gray-300 hover:bg-gray-700 hover:border-amber-400 transition-all" data-cuisine="taiwanese">ğŸœ å°å¼</button>
                    <button class="cuisine-btn px-4 py-2 border-2 border-amber-500/50 bg-gray-800 rounded-lg text-gray-300 hover:bg-gray-700 hover:border-amber-400 transition-all" data-cuisine="other">ğŸ½ï¸ å…¶ä»–</button>
                </div>
            </div>

            <!-- æœå°‹èˆ‡éš¨ä¾¿æŒ‰éˆ• -->
            <div class="mt-4 flex gap-3">
                <button 
                    id="search-btn" 
                    class="flex-1 px-8 py-3 btn-gold text-gray-900 font-bold rounded-lg shadow-lg hover:shadow-amber-500/50 transform hover:scale-105 transition-all duration-200"
                >
                    ğŸ” æœå°‹ç¾é£Ÿ
                </button>
                <button 
                    id="random-btn" 
                    class="px-8 py-3 bg-gradient-to-r from-amber-600 to-amber-500 text-gray-900 font-bold rounded-lg shadow-lg hover:from-amber-500 hover:to-amber-400 hover:shadow-amber-500/50 transform hover:scale-105 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none"
                    disabled
                >
                    ğŸ² éš¨ä¾¿
                </button>
            </div>
        </div>

        <!-- è¼‰å…¥æ›´å¤šæŒ‰éˆ• -->
        <div id="load-more-container" class="hidden text-center mb-8">
            <button 
                id="load-more-btn" 
                class="px-8 py-3 btn-gold text-gray-900 font-bold rounded-lg shadow-lg hover:shadow-amber-500/50 transition-all"
            >
                è¼‰å…¥æ›´å¤šé¤å»³
            </button>
        </div>

        <!-- Loading ç‹€æ…‹ -->
        <div id="loading" class="hidden text-center py-12">
            <div class="inline-block w-16 h-16 border-4 border-gray-700 border-t-amber-500 rounded-full spinner"></div>
            <p class="mt-4 text-amber-400 font-semibold tracking-wide">æ­£åœ¨æœå°‹é™„è¿‘çš„ç¾å‘³é¤å»³...</p>
        </div>

        <!-- éŒ¯èª¤è¨Šæ¯ -->
        <div id="error-message" class="hidden bg-red-900/30 border-l-4 border-red-500 text-red-300 p-4 rounded-lg mb-6 backdrop-blur-sm">
            <p class="font-bold">âš ï¸ ç™¼ç”ŸéŒ¯èª¤</p>
            <p id="error-text"></p>
        </div>

        <!-- çµæœå€åŸŸ -->
        <div id="results" class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- å‹•æ…‹ç”Ÿæˆçš„é¤å»³å¡ç‰‡å°‡é¡¯ç¤ºåœ¨é€™è£¡ -->
        </div>

        <!-- ç„¡çµæœæç¤º -->
        <div id="no-results" class="hidden text-center py-12">
            <div class="text-6xl mb-4">ğŸ˜¢</div>
            <p class="text-xl text-amber-400 font-semibold">æŠ±æ­‰ï¼Œæ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„é¤å»³</p>
            <p class="text-gray-400 mt-2">è«‹å˜—è©¦èª¿æ•´æœå°‹æ¢ä»¶æˆ–æ›´æ›åœ°é»</p>
        </div>
    </div>

    <!-- è½‰ç›¤æ¨¡æ…‹æ¡† -->
    <div id="wheel-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
        <div class="bg-gray-900 border border-amber-500/30 rounded-3xl p-8 max-w-2xl mx-4 shadow-2xl">
            <h2 class="text-3xl font-bold text-amber-400 text-center mb-6 tracking-wide">ğŸ° å¹¸é‹è½‰ç›¤</h2>
            
            <!-- è½‰ç›¤ -->
            <div class="flex justify-center mb-6 relative">
                <div class="wheel-pointer"></div>
                <div id="wheel" class="wheel-container">
                    <!-- é¤å»³æ‰‡å½¢å°‡ç”± JavaScript å‹•æ…‹ç”Ÿæˆ -->
                    <div class="wheel-center">ğŸœ</div>
                </div>
            </div>
            
            <!-- çµæœé¡¯ç¤º -->
            <div id="wheel-result" class="hidden">
                <div class="bg-gradient-to-r from-amber-900/40 to-amber-800/40 border border-amber-500/30 rounded-xl p-6 mb-4 backdrop-blur-sm">
                    <h3 class="text-xl font-bold text-amber-400 mb-2" id="selected-restaurant-name"></h3>
                    <p class="text-gray-300" id="selected-restaurant-rating"></p>
                </div>
                <div class="flex gap-3">
                    <button 
                        id="spin-again-btn" 
                        class="flex-1 px-6 py-3 btn-gold text-gray-900 font-bold rounded-lg hover:shadow-amber-500/50 transition-all"
                    >
                        ğŸ² å†è½‰ä¸€æ¬¡
                    </button>
                    <button 
                        id="close-wheel-btn" 
                        class="flex-1 px-6 py-3 bg-gray-700 text-gray-200 font-bold rounded-lg hover:bg-gray-600 transition-all"
                    >
                        é—œé–‰
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // å…¨åŸŸè®Šæ•¸èˆ‡ç‹€æ…‹ç®¡ç†
        // ============================================
        
        let autocomplete; // Google Places Autocomplete å¯¦ä¾‹
        let selectedLocation = null; // ä½¿ç”¨è€…é¸æ“‡çš„ä½ç½®
        let selectedPriceLevels = [1, 2, 3, 4]; // é è¨­é¸æ“‡æ‰€æœ‰åƒ¹æ ¼ç­‰ç´š
        let selectedCuisineTypes = []; // é¸æ“‡çš„é¤å»³é¡åˆ¥
        let map; // Google Map å¯¦ä¾‹ï¼ˆéš±è—ï¼Œåƒ…ç”¨æ–¼æœå‹™ï¼‰
        let placesService; // Places Service å¯¦ä¾‹
        let allResults = []; // å„²å­˜æ‰€æœ‰æœå°‹çµæœï¼ˆç”¨æ–¼åˆ†é èˆ‡è½‰ç›¤ï¼‰
        let displayedCount = 0; // å·²é¡¯ç¤ºçš„é¤å»³æ•¸é‡
        let selectedRestaurants = new Set(); // å·²è¢«è½‰ç›¤é¸éçš„é¤å»³ (place_id)

        // ============================================
        // åˆå§‹åŒ–å‡½å¼
        // ============================================
        
        function init() {
            // åˆå§‹åŒ– Google Places Autocomplete (é™åˆ¶å°ç£åœ°å€)
            const input = document.getElementById('location-input');
            autocomplete = new google.maps.places.Autocomplete(input, {
                types: ['geocode', 'establishment'],
                componentRestrictions: { country: 'tw' } // é™åˆ¶åƒ…æœå°‹å°ç£
            });
            
            // ç›£è½è¼¸å…¥äº‹ä»¶ï¼Œè‡³å°‘ 3 å€‹å­—æ‰å•Ÿç”¨ autocomplete
            let autocompleteEnabled = false;
            input.addEventListener('input', (e) => {
                const value = e.target.value;
                if (value.length >= 3 && !autocompleteEnabled) {
                    // å•Ÿç”¨ autocomplete
                    autocompleteEnabled = true;
                } else if (value.length < 3 && autocompleteEnabled) {
                    // ç¦ç”¨ autocomplete (æ¸…ç©ºé¸æ“‡)
                    autocompleteEnabled = false;
                    selectedLocation = null;
                }
            });
            
            // ç›£è½åœ°é»é¸æ“‡äº‹ä»¶
            autocomplete.addListener('place_changed', onPlaceChanged);
            
            // åˆå§‹åŒ–éš±è—çš„åœ°åœ–ï¼ˆç”¨æ–¼ PlacesServiceï¼‰
            map = new google.maps.Map(document.createElement('div'));
            placesService = new google.maps.places.PlacesService(map);
            
            // ç¶å®šè©•åˆ†æ»‘æ¡¿äº‹ä»¶
            const ratingSlider = document.getElementById('rating-slider');
            ratingSlider.addEventListener('input', (e) => {
                document.getElementById('rating-value').textContent = e.target.value;
            });
            
            // ç¶å®šåƒ¹æ ¼æŒ‰éˆ•äº‹ä»¶
            const priceBtns = document.querySelectorAll('.price-btn');
            priceBtns.forEach(btn => {
                btn.addEventListener('click', togglePriceLevel);
            });
            
            // é è¨­é¸ä¸­æ‰€æœ‰åƒ¹æ ¼ç­‰ç´š
            priceBtns.forEach(btn => btn.classList.add('bg-amber-500', 'text-gray-900', 'border-amber-500'));
            
            // ç¶å®šé¤å»³é¡åˆ¥æŒ‰éˆ•äº‹ä»¶
            const cuisineBtns = document.querySelectorAll('.cuisine-btn');
            cuisineBtns.forEach(btn => {
                btn.addEventListener('click', toggleCuisineType);
            });
            
            // é è¨­é¸ä¸­ã€Œå…¶ä»–ã€é¡åˆ¥
            selectedCuisineTypes = ['other'];
            document.querySelector('[data-cuisine="other"]').classList.add('bg-amber-500', 'text-gray-900', 'border-amber-500');
            
            // ç¶å®šæœå°‹æŒ‰éˆ•äº‹ä»¶
            document.getElementById('search-btn').addEventListener('click', searchRestaurants);
            
            // ç¶å®šéš¨ä¾¿æŒ‰éˆ•äº‹ä»¶
            document.getElementById('random-btn').addEventListener('click', showWheelModal);
            
            // ç¶å®šè½‰ç›¤æ¨¡æ…‹æ¡†æŒ‰éˆ•
            document.getElementById('spin-again-btn').addEventListener('click', spinWheel);
            document.getElementById('close-wheel-btn').addEventListener('click', closeWheelModal);
            
            // ç¶å®šè¼‰å…¥æ›´å¤šæŒ‰éˆ•
            document.getElementById('load-more-btn').addEventListener('click', loadMoreRestaurants);
        }

        // ============================================
        // åœ°é»é¸æ“‡è™•ç†
        // ============================================
        
        function onPlaceChanged() {
            const place = autocomplete.getPlace();
            if (!place.geometry || !place.geometry.location) {
                showError('è«‹é¸æ“‡ä¸€å€‹æœ‰æ•ˆçš„åœ°é»');
                return;
            }
            selectedLocation = {
                lat: place.geometry.location.lat(),
                lng: place.geometry.location.lng(),
                name: place.name || place.formatted_address
            };
        }

        // ============================================
        // åƒ¹æ ¼ç­‰ç´šåˆ‡æ›
        // ============================================
        
        function togglePriceLevel(e) {
            const btn = e.target;
            const price = parseInt(btn.dataset.price);
            
            if (btn.classList.contains('bg-amber-500')) {
                // å–æ¶ˆé¸æ“‡
                btn.classList.remove('bg-amber-500', 'text-gray-900', 'border-amber-500');
                btn.classList.add('border-amber-500/50', 'text-gray-300', 'bg-gray-800');
                selectedPriceLevels = selectedPriceLevels.filter(p => p !== price);
            } else {
                // é¸æ“‡
                btn.classList.add('bg-amber-500', 'text-gray-900', 'border-amber-500');
                btn.classList.remove('border-amber-500/50', 'text-gray-300', 'bg-gray-800');
                selectedPriceLevels.push(price);
            }
        }

        // ============================================
        // é¤å»³é¡åˆ¥åˆ‡æ›
        // ============================================
        
        function toggleCuisineType(e) {
            const btn = e.target;
            const cuisine = btn.dataset.cuisine;
            
            if (btn.classList.contains('bg-amber-500')) {
                // å–æ¶ˆé¸æ“‡
                btn.classList.remove('bg-amber-500', 'text-gray-900', 'border-amber-500');
                btn.classList.add('border-amber-500/50', 'text-gray-300', 'bg-gray-800');
                selectedCuisineTypes = selectedCuisineTypes.filter(c => c !== cuisine);
            } else {
                // é¸æ“‡
                btn.classList.add('bg-amber-500', 'text-gray-900', 'border-amber-500');
                btn.classList.remove('border-amber-500/50', 'text-gray-300', 'bg-gray-800');
                selectedCuisineTypes.push(cuisine);
            }
        }

        // ============================================
        // ä¸»æœå°‹å‡½å¼
        // ============================================
        
        async function searchRestaurants() {
            // é©—è­‰è¼¸å…¥
            if (!selectedLocation) {
                showError('è«‹å…ˆé¸æ“‡ä¸€å€‹åœ°é»');
                return;
            }
            
            if (selectedPriceLevels.length === 0) {
                showError('è«‹è‡³å°‘é¸æ“‡ä¸€å€‹åƒ¹æ ¼ç­‰ç´š');
                return;
            }
            
            if (selectedCuisineTypes.length === 0) {
                showError('è«‹è‡³å°‘é¸æ“‡ä¸€å€‹é¤å»³é¡åˆ¥');
                return;
            }
            
            // å–å¾—æœ€ä½è©•åˆ†
            const minRating = parseFloat(document.getElementById('rating-slider').value);
            
            // é¡¯ç¤º Loading ç‹€æ…‹
            showLoading();
            hideError();
            clearResults();
            
            // é‡ç½®ç‹€æ…‹
            allResults = [];
            displayedCount = 0;
            selectedRestaurants.clear();
            
            try {
                // æ­¥é©Ÿ 1: ä½¿ç”¨ nearbySearch æœå°‹é¤å»³ï¼ˆæ ¹æ“šé¤å»³é¡åˆ¥ï¼‰
                const nearbyResults = await searchNearbyRestaurants(selectedLocation, minRating);
                
                // æ­¥é©Ÿ 2: éæ¿¾åƒ¹æ ¼ç­‰ç´š
                const filteredByPrice = nearbyResults.filter(place => 
                    !place.price_level || selectedPriceLevels.includes(place.price_level)
                );
                
                // æ­¥é©Ÿ 3: æŒ‰è©•åˆ†æ’åºï¼Œå–å‰ 30 ç­†ï¼ˆæº–å‚™æ›´å¤šå€™é¸ï¼‰
                const top30 = filteredByPrice
                    .sort((a, b) => (b.rating || 0) - (a.rating || 0))
                    .slice(0, 30);
                
                // æ­¥é©Ÿ 4: å°å‰ 30 ç­†é€²è¡Œè©³ç´°è³‡è¨ŠæŸ¥è©¢ï¼ˆåŒ…å«ç‡Ÿæ¥­æ™‚é–“ï¼‰
                const detailedResults = await Promise.all(
                    top30.map(place => getPlaceDetails(place.place_id))
                );
                
                // æ­¥é©Ÿ 5: éæ¿¾å‡ºã€Œ120 åˆ†é˜å¾Œä»ç‡Ÿæ¥­ã€çš„é¤å»³
                const openIn120Min = detailedResults.filter(place => 
                    place && isOpenIn120Minutes(place)
                );
                
                // æ­¥é©Ÿ 6: æŒ‰è©•åˆ†æ’åºï¼Œå„²å­˜æ‰€æœ‰çµæœ
                allResults = openIn120Min.sort((a, b) => (b.rating || 0) - (a.rating || 0));
                
                // æ­¥é©Ÿ 7: é¡¯ç¤ºå‰ 15 ç­†
                hideLoading();
                displayInitialResults();
                
                // å•Ÿç”¨éš¨ä¾¿æŒ‰éˆ•
                document.getElementById('random-btn').disabled = allResults.length === 0;
                
            } catch (error) {
                hideLoading();
                showError('æœå°‹æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š' + error.message);
            }
        }

        // ============================================
        // Google Places API å‘¼å«
        // ============================================
        
        /**
         * ä½¿ç”¨ nearbySearch æœå°‹é™„è¿‘é¤å»³
         */
        function searchNearbyRestaurants(location, minRating) {
            return new Promise((resolve, reject) => {
                // æ ¹æ“šé¸æ“‡çš„é¤å»³é¡åˆ¥å»ºç«‹æœå°‹é—œéµå­—
                let keyword = '';
                if (!selectedCuisineTypes.includes('other')) {
                    const keywords = {
                        'japanese': 'japanese sushi ramen',
                        'italian': 'italian pizza pasta',
                        'korean': 'korean bbq',
                        'taiwanese': 'taiwanese å°åƒ å°èœ'
                    };
                    keyword = selectedCuisineTypes.map(type => keywords[type] || '').join(' ');
                }
                
                const request = {
                    location: new google.maps.LatLng(location.lat, location.lng),
                    radius: 2000, // 2000 å…¬å°º
                    type: 'restaurant',
                    keyword: keyword || undefined
                };
                
                placesService.nearbySearch(request, (results, status) => {
                    if (status === google.maps.places.PlacesServiceStatus.OK) {
                        // éæ¿¾è©•åˆ†
                        const filtered = results.filter(place => 
                            place.rating && place.rating >= minRating
                        );
                        resolve(filtered);
                    } else {
                        reject(new Error('æœå°‹å¤±æ•—ï¼š' + status));
                    }
                });
            });
        }

        /**
         * å–å¾—é¤å»³è©³ç´°è³‡è¨Šï¼ˆåŒ…å«ç‡Ÿæ¥­æ™‚é–“ï¼‰
         */
        function getPlaceDetails(placeId) {
            return new Promise((resolve, reject) => {
                const request = {
                    placeId: placeId,
                    fields: ['name', 'rating', 'user_ratings_total', 'price_level', 'opening_hours', 'vicinity', 'place_id']
                };
                
                placesService.getDetails(request, (place, status) => {
                    if (status === google.maps.places.PlacesServiceStatus.OK) {
                        resolve(place);
                    } else {
                        // å¦‚æœå–®ä¸€é¤å»³æŸ¥è©¢å¤±æ•—ï¼Œè¿”å› null è€Œéæ‹’çµ•
                        resolve(null);
                    }
                });
            });
        }

        // ============================================
        // 120 åˆ†é˜ç‡Ÿæ¥­é‚è¼¯åˆ¤æ–·
        // ============================================
        
        /**
         * åˆ¤æ–·é¤å»³åœ¨ã€Œç•¶å‰æ™‚é–“ + 120 åˆ†é˜ã€æ˜¯å¦ç‡Ÿæ¥­
         */
        function isOpenIn120Minutes(place) {
            // å¦‚æœæ²’æœ‰ç‡Ÿæ¥­æ™‚é–“è³‡è¨Šï¼Œé è¨­ç‚ºä¸ç¬¦åˆï¼ˆä¿å®ˆåšæ³•ï¼‰
            if (!place || !place.opening_hours || !place.opening_hours.periods) {
                return false;
            }
            
            // è¨ˆç®—ç›®æ¨™æ™‚é–“ï¼ˆç•¶å‰æ™‚é–“ + 120 åˆ†é˜ï¼‰
            const now = new Date();
            const targetTime = new Date(now.getTime() + 120 * 60 * 1000);
            const targetDay = targetTime.getDay(); // 0 = Sunday, 1 = Monday, ..., 6 = Saturday
            const targetMinutes = targetTime.getHours() * 60 + targetTime.getMinutes();
            
            // æª¢æŸ¥è©²æ™‚æ®µæ˜¯å¦ç‡Ÿæ¥­
            const periods = place.opening_hours.periods;
            
            for (let period of periods) {
                const openDay = period.open.day;
                const openTime = period.open.hours * 60 + period.open.minutes;
                
                // è™•ç† 24 å°æ™‚ç‡Ÿæ¥­çš„æƒ…æ³
                if (!period.close) {
                    return true;
                }
                
                const closeDay = period.close.day;
                const closeTime = period.close.hours * 60 + period.close.minutes;
                
                // æƒ…æ³ 1: æœªè·¨æ—¥ï¼ˆopen å’Œ close åœ¨åŒä¸€å¤©ï¼‰
                if (openDay === closeDay) {
                    if (targetDay === openDay && targetMinutes >= openTime && targetMinutes < closeTime) {
                        return true;
                    }
                }
                // æƒ…æ³ 2: è·¨æ—¥ï¼ˆä¾‹å¦‚é€±äº” 22:00 ~ é€±å…­ 02:00ï¼‰
                else {
                    // æª¢æŸ¥æ˜¯å¦åœ¨é–‹å§‹æ—¥æœŸçš„ç‡Ÿæ¥­æ™‚é–“å…§
                    if (targetDay === openDay && targetMinutes >= openTime) {
                        return true;
                    }
                    // æª¢æŸ¥æ˜¯å¦åœ¨çµæŸæ—¥æœŸçš„ç‡Ÿæ¥­æ™‚é–“å…§
                    if (targetDay === closeDay && targetMinutes < closeTime) {
                        return true;
                    }
                }
            }
            
            return false;
        }

        // ============================================
        // UI æ›´æ–°å‡½å¼
        // ============================================
        
        /**
         * é¡¯ç¤ºåˆå§‹æœå°‹çµæœï¼ˆå‰ 15 ç­†ï¼‰
         */
        function displayInitialResults() {
            const resultsContainer = document.getElementById('results');
            const noResults = document.getElementById('no-results');
            const loadMoreContainer = document.getElementById('load-more-container');
            
            if (allResults.length === 0) {
                noResults.classList.remove('hidden');
                loadMoreContainer.classList.add('hidden');
                return;
            }
            
            noResults.classList.add('hidden');
            
            // é¡¯ç¤ºå‰ 15 ç­†
            const initialResults = allResults.slice(0, 15);
            displayedCount = initialResults.length;
            
            initialResults.forEach(restaurant => {
                const card = createRestaurantCard(restaurant);
                resultsContainer.appendChild(card);
            });
            
            // é¡¯ç¤ºæˆ–éš±è—ã€Œè¼‰å…¥æ›´å¤šã€æŒ‰éˆ•
            if (allResults.length > 15) {
                loadMoreContainer.classList.remove('hidden');
            } else {
                loadMoreContainer.classList.add('hidden');
            }
        }
        
        /**
         * è¼‰å…¥æ›´å¤šé¤å»³ï¼ˆæ¯æ¬¡ 10 ç­†ï¼‰
         */
        function loadMoreRestaurants() {
            const resultsContainer = document.getElementById('results');
            const loadMoreContainer = document.getElementById('load-more-container');
            
            // è¨ˆç®—ä¸‹ä¸€æ‰¹è¦é¡¯ç¤ºçš„é¤å»³
            const nextBatch = allResults.slice(displayedCount, displayedCount + 10);
            
            nextBatch.forEach(restaurant => {
                const card = createRestaurantCard(restaurant);
                resultsContainer.appendChild(card);
            });
            
            displayedCount += nextBatch.length;
            
            // å¦‚æœæ²’æœ‰æ›´å¤šçµæœï¼Œéš±è—æŒ‰éˆ•
            if (displayedCount >= allResults.length) {
                loadMoreContainer.classList.add('hidden');
            }
        }
        
        /**
         * é¡¯ç¤ºæœå°‹çµæœï¼ˆèˆŠç‰ˆï¼Œä¿ç•™ä»¥é˜²éœ€è¦ï¼‰
         */
        function displayResults(restaurants) {
            const resultsContainer = document.getElementById('results');
            const noResults = document.getElementById('no-results');
            
            if (restaurants.length === 0) {
                noResults.classList.remove('hidden');
                return;
            }
            
            noResults.classList.add('hidden');
            
            restaurants.forEach(restaurant => {
                const card = createRestaurantCard(restaurant);
                resultsContainer.appendChild(card);
            });
        }

        /**
         * å»ºç«‹é¤å»³å¡ç‰‡
         */
        function createRestaurantCard(restaurant) {
            const card = document.createElement('div');
            card.className = 'bg-gray-800 rounded-xl border border-amber-500/30 shadow-lg overflow-hidden hover:shadow-2xl hover:shadow-amber-500/20 hover:border-amber-500/50 transition-all duration-300';
            
            // åƒ¹æ ¼ç­‰ç´šé¡¯ç¤º
            const priceDisplay = '$'.repeat(restaurant.price_level || 1);
            
            // æ˜Ÿæ˜Ÿè©•åˆ†
            const stars = generateStars(restaurant.rating || 0);
            
            // ç‡Ÿæ¥­ç‹€æ…‹æ¨™ç±¤
            const statusBadge = '<span class="inline-block px-3 py-1 bg-amber-500/20 border border-amber-500/50 text-amber-400 text-xs font-semibold rounded-full">âœ“ 120åˆ†é˜å…§ç‡Ÿæ¥­</span>';
            
            card.innerHTML = `
                <div class="p-6">
                    <!-- åº—å -->
                    <h3 class="text-xl font-bold text-amber-400 mb-2 line-clamp-1">
                        ${restaurant.name}
                    </h3>
                    
                    <!-- è©•åˆ†èˆ‡è©•è«–æ•¸ -->
                    <div class="flex items-center gap-2 mb-3">
                        <div class="flex items-center">
                            ${stars}
                            <span class="ml-2 text-lg font-semibold text-amber-300">${restaurant.rating || 'N/A'}</span>
                        </div>
                        <span class="text-gray-400 text-sm">(${restaurant.user_ratings_total || 0} å‰‡è©•è«–)</span>
                    </div>
                    
                    <!-- åƒ¹æ ¼ç­‰ç´š -->
                    <div class="mb-3">
                        <span class="text-amber-400 font-bold text-lg">${priceDisplay}</span>
                    </div>
                    
                    <!-- åœ°å€ -->
                    <p class="text-gray-300 text-sm mb-4 line-clamp-2">
                        ğŸ“ ${restaurant.vicinity || 'åœ°å€è³‡è¨Šä¸å¯ç”¨'}
                    </p>
                    
                    <!-- ç‡Ÿæ¥­ç‹€æ…‹æ¨™ç±¤ -->
                    <div class="mb-4">
                        ${statusBadge}
                    </div>
                    
                    <!-- Google Maps é€£çµ -->
                    <a 
                        href="https://www.google.com/maps/place/?q=place_id:${restaurant.place_id}" 
                        target="_blank" 
                        class="inline-block w-full text-center px-4 py-2 btn-gold text-gray-900 font-semibold rounded-lg hover:shadow-amber-500/50 transition-all"
                    >
                        åœ¨ Google Maps ä¸­æŸ¥çœ‹
                    </a>
                </div>
            `;
            
            return card;
        }

        /**
         * ç”Ÿæˆæ˜Ÿæ˜Ÿè©•åˆ† HTML
         */
        function generateStars(rating) {
            const fullStars = Math.floor(rating);
            const hasHalfStar = rating % 1 >= 0.5;
            let starsHTML = '';
            
            for (let i = 0; i < fullStars; i++) {
                starsHTML += '<span class="star">â˜…</span>';
            }
            
            if (hasHalfStar) {
                starsHTML += '<span class="star">â¯¨</span>';
            }
            
            const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);
            for (let i = 0; i < emptyStars; i++) {
                starsHTML += '<span class="text-gray-300">â˜…</span>';
            }
            
            return starsHTML;
        }

        /**
         * é¡¯ç¤º Loading ç‹€æ…‹
         */
        function showLoading() {
            document.getElementById('loading').classList.remove('hidden');
        }

        /**
         * éš±è— Loading ç‹€æ…‹
         */
        function hideLoading() {
            document.getElementById('loading').classList.add('hidden');
        }

        /**
         * é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
         */
        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            const errorText = document.getElementById('error-text');
            errorText.textContent = message;
            errorDiv.classList.remove('hidden');
        }

        /**
         * éš±è—éŒ¯èª¤è¨Šæ¯
         */
        function hideError() {
            document.getElementById('error-message').classList.add('hidden');
        }

        /**
         * æ¸…ç©ºæœå°‹çµæœ
         */
        function clearResults() {
            document.getElementById('results').innerHTML = '';
            document.getElementById('no-results').classList.add('hidden');
            document.getElementById('load-more-container').classList.add('hidden');
        }

        // ============================================
        // è½‰ç›¤åŠŸèƒ½
        // ============================================
        
        /**
         * é¡¯ç¤ºè½‰ç›¤æ¨¡æ…‹æ¡†
         */
        function showWheelModal() {
            if (allResults.length === 0) {
                showError('è«‹å…ˆæœå°‹é¤å»³');
                return;
            }
            
            // æª¢æŸ¥æ˜¯å¦æ‰€æœ‰é¤å»³éƒ½å·²è¢«é¸é
            if (selectedRestaurants.size >= allResults.length) {
                // é‡æ–°è¼‰å…¥æ–°çš„ä¸€æ‰¹é¤å»³
                autoRefreshRestaurants();
                return;
            }
            
            // å»ºç«‹è½‰ç›¤
            buildWheel();
            
            document.getElementById('wheel-modal').classList.remove('hidden');
            document.getElementById('wheel-result').classList.add('hidden');
            
            // è‡ªå‹•é–‹å§‹è½‰å‹•
            setTimeout(() => spinWheel(), 500);
        }
        
        /**
         * å»ºç«‹è½‰ç›¤ - é¡¯ç¤ºæ‰€æœ‰å¯é¸é¤å»³
         */
        function buildWheel() {
            const wheel = document.getElementById('wheel');
            const availableRestaurants = allResults.filter(r => !selectedRestaurants.has(r.place_id));
            
            const sliceCount = availableRestaurants.length;
            const sliceAngle = 360 / sliceCount;
            
            // é¡è‰²é™£åˆ—ï¼ˆé‡‘è‰²ç³»ï¼‰
            const colors = [
                '#d97706', '#f59e0b', '#fbbf24', '#b45309',
                '#ea580c', '#fb923c', '#fdba74', '#c2410c'
            ];
            
            // å‰µå»º SVG
            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.setAttribute('id', 'wheel-svg');
            svg.setAttribute('viewBox', '0 0 400 400');
            
            const centerX = 200;
            const centerY = 200;
            const radius = 200;
            
            availableRestaurants.forEach((restaurant, index) => {
                const startAngle = (index * sliceAngle - 90) * Math.PI / 180;
                const endAngle = ((index + 1) * sliceAngle - 90) * Math.PI / 180;
                
                // è¨ˆç®—æ‰‡å½¢è·¯å¾‘
                const x1 = centerX + radius * Math.cos(startAngle);
                const y1 = centerY + radius * Math.sin(startAngle);
                const x2 = centerX + radius * Math.cos(endAngle);
                const y2 = centerY + radius * Math.sin(endAngle);
                
                const largeArcFlag = sliceAngle > 180 ? 1 : 0;
                
                const pathData = `M ${centerX} ${centerY} L ${x1} ${y1} A ${radius} ${radius} 0 ${largeArcFlag} 1 ${x2} ${y2} Z`;
                
                // å‰µå»ºæ‰‡å½¢
                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                path.setAttribute('d', pathData);
                path.setAttribute('fill', colors[index % colors.length]);
                path.setAttribute('stroke', 'white');
                path.setAttribute('stroke-width', '2');
                svg.appendChild(path);
                
                // æ·»åŠ ç›´å¼æ–‡å­—
                const midAngle = (startAngle + endAngle) / 2;
                const textRadius = radius * 0.55; // èª¿æ•´ç‚º 55% é¿å…èˆ‡æŒ‡é‡é‡ç–Š
                const textX = centerX + textRadius * Math.cos(midAngle);
                const textY = centerY + textRadius * Math.sin(midAngle);
                
                // è¨ˆç®—æ–‡å­—æ—‹è½‰è§’åº¦ï¼ˆç›´å¼æ–‡å­—ï¼‰
                const textRotation = (index * sliceAngle + sliceAngle / 2);
                
                // æˆªæ–·éé•·çš„åç¨±
                let displayName = restaurant.name;
                if (displayName.length > 8) {
                    displayName = displayName.substring(0, 8) + '...';
                }
                
                // å‰µå»ºæ–‡å­—ç¾¤çµ„
                const textGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                textGroup.setAttribute('transform', `translate(${textX}, ${textY}) rotate(${textRotation})`);
                
                // é€å­—æ·»åŠ ï¼ˆç›´å¼æ’åˆ—ï¼‰
                const chars = displayName.split('');
                chars.forEach((char, charIndex) => {
                    const charText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    charText.setAttribute('x', 0);
                    charText.setAttribute('y', (charIndex - chars.length / 2) * 16 + 8); // å­—é–“è·æ”¹ç‚º 16px
                    charText.setAttribute('class', 'wheel-text');
                    charText.textContent = char;
                    textGroup.appendChild(charText);
                });
                
                svg.appendChild(textGroup);
            });
            
            // æ¸…ç©ºä¸¦æ·»åŠ  SVGï¼ˆä¸å†éœ€è¦ä¸­å¿ƒåœ–ç¤ºï¼‰
            wheel.innerHTML = '';
            wheel.appendChild(svg);
        }
        
        /**
         * é—œé–‰è½‰ç›¤æ¨¡æ…‹æ¡†
         */
        function closeWheelModal() {
            document.getElementById('wheel-modal').classList.add('hidden');
        }
        
        /**
         * è½‰å‹•è½‰ç›¤
         */
        function spinWheel() {
            const wheel = document.getElementById('wheel');
            const resultDiv = document.getElementById('wheel-result');
            
            // éš±è—çµæœ
            resultDiv.classList.add('hidden');
            
            // éæ¿¾å‡ºå°šæœªè¢«é¸éçš„é¤å»³
            const availableRestaurants = allResults.filter(r => !selectedRestaurants.has(r.place_id));
            
            if (availableRestaurants.length === 0) {
                // æ‰€æœ‰é¤å»³éƒ½å·²è¢«é¸éï¼Œè‡ªå‹•åˆ·æ–°
                closeWheelModal();
                autoRefreshRestaurants();
                return;
            }
            
            // éš¨æ©Ÿé¸æ“‡ä¸€å®¶é¤å»³
            const randomIndex = Math.floor(Math.random() * availableRestaurants.length);
            const selectedRestaurant = availableRestaurants[randomIndex];
            
            // æ¨™è¨˜ç‚ºå·²é¸æ“‡
            selectedRestaurants.add(selectedRestaurant.place_id);
            
            // è¨ˆç®—æ—‹è½‰è§’åº¦
            // æ¯å€‹æ‰‡å½¢çš„è§’åº¦
            const sliceAngle = 360 / availableRestaurants.length;
            
            // ç›®æ¨™æ‰‡å½¢çš„ä¸­å¿ƒè§’åº¦ï¼ˆé †æ™‚é‡ï¼Œå¾æ­£ä¸Šæ–¹0åº¦é–‹å§‹ï¼‰
            const targetAngle = randomIndex * sliceAngle + (sliceAngle / 2);
            
            // è¨ˆç®—éœ€è¦æ—‹è½‰çš„è§’åº¦ï¼š
            // 1. æŒ‡é‡åœ¨æ­£ä¸Šæ–¹ (0åº¦)
            // 2. è¦è®“é¸ä¸­çš„æ‰‡å½¢è½‰åˆ°æ­£ä¸Šæ–¹ï¼Œéœ€è¦é€†æ™‚é‡æ—‹è½‰ targetAngle
            // 3. åŠ ä¸Šå¤šåœˆæ—‹è½‰ (5åœˆ = 1800åº¦) è®“å‹•ç•«æ›´æœ‰è¶£
            const baseRotation = 1800; // 5åœˆ
            const finalRotation = baseRotation + (360 - targetAngle);
            
            // ç§»é™¤èˆŠçš„å‹•ç•«é¡åˆ¥
            wheel.classList.remove('wheel-spinning');
            wheel.style.transform = 'rotate(0deg)';
            
            // å¼·åˆ¶é‡ç¹ª
            void wheel.offsetWidth;
            
            // è¨­å®šè‡ªè¨‚æ—‹è½‰è§’åº¦
            wheel.style.setProperty('--spin-rotation', `${finalRotation}deg`);
            
            // æ·»åŠ å‹•ç•«é¡åˆ¥
            wheel.classList.add('wheel-spinning');
            
            // 2 ç§’å¾Œé¡¯ç¤ºçµæœ
            setTimeout(() => {
                wheel.classList.remove('wheel-spinning');
                // ä¿æŒæœ€çµ‚è§’åº¦
                wheel.style.transform = `rotate(${finalRotation}deg)`;
                showWheelResult(selectedRestaurant);
            }, 2000);
        }
        
        /**
         * é¡¯ç¤ºè½‰ç›¤çµæœ
         */
        function showWheelResult(restaurant) {
            const resultDiv = document.getElementById('wheel-result');
            const nameEl = document.getElementById('selected-restaurant-name');
            const ratingEl = document.getElementById('selected-restaurant-rating');
            
            nameEl.textContent = restaurant.name;
            ratingEl.textContent = `â­ ${restaurant.rating} (${restaurant.user_ratings_total} å‰‡è©•è«–)`;
            
            resultDiv.classList.remove('hidden');
            
            // æ›´æ–°å†è½‰ä¸€æ¬¡æŒ‰éˆ•ç‹€æ…‹
            const availableCount = allResults.length - selectedRestaurants.size;
            const spinAgainBtn = document.getElementById('spin-again-btn');
            
            if (availableCount === 0) {
                spinAgainBtn.textContent = 'ğŸ”„ è¼‰å…¥æ–°é¤å»³';
            } else {
                spinAgainBtn.textContent = `ğŸ² å†è½‰ä¸€æ¬¡ (å‰©é¤˜ ${availableCount})`;
            }
        }
        
        /**
         * è‡ªå‹•åˆ·æ–°é¤å»³ï¼ˆç•¶æ‰€æœ‰é¤å»³éƒ½è¢«é¸éæ™‚ï¼‰
         */
        async function autoRefreshRestaurants() {
            showLoading();
            closeWheelModal();
            
            try {
                // ä½¿ç”¨ç›¸åŒçš„æœå°‹æ¢ä»¶ï¼Œä½†è·³éå‰ N ç­†çµæœ
                const minRating = parseFloat(document.getElementById('rating-slider').value);
                const nearbyResults = await searchNearbyRestaurants(selectedLocation, minRating);
                
                // éæ¿¾åƒ¹æ ¼ç­‰ç´š
                const filteredByPrice = nearbyResults.filter(place => 
                    !place.price_level || selectedPriceLevels.includes(place.price_level)
                );
                
                // æŒ‰è©•åˆ†æ’åºï¼Œè·³éå·²é¡¯ç¤ºçš„ï¼Œå–æ–°çš„ 30 ç­†
                const newCandidates = filteredByPrice
                    .sort((a, b) => (b.rating || 0) - (a.rating || 0))
                    .filter(place => !allResults.some(r => r.place_id === place.place_id))
                    .slice(0, 30);
                
                if (newCandidates.length === 0) {
                    hideLoading();
                    showError('é™„è¿‘æ²’æœ‰æ›´å¤šç¬¦åˆæ¢ä»¶çš„é¤å»³äº†');
                    return;
                }
                
                // å–å¾—è©³ç´°è³‡è¨Š
                const detailedResults = await Promise.all(
                    newCandidates.map(place => getPlaceDetails(place.place_id))
                );
                
                // éæ¿¾ç‡Ÿæ¥­ä¸­çš„é¤å»³
                const openIn120Min = detailedResults.filter(place => 
                    place && isOpenIn120Minutes(place)
                );
                
                // å–å‰ 10 ç­†æ–°é¤å»³
                const newRestaurants = openIn120Min
                    .sort((a, b) => (b.rating || 0) - (a.rating || 0))
                    .slice(0, 10);
                
                if (newRestaurants.length === 0) {
                    hideLoading();
                    showError('é™„è¿‘æ²’æœ‰æ›´å¤šç¬¦åˆæ¢ä»¶çš„é¤å»³äº†');
                    return;
                }
                
                // æ›¿æ› allResults
                allResults = newRestaurants;
                selectedRestaurants.clear();
                
                hideLoading();
                
                // é¡¯ç¤ºé€šçŸ¥
                setTimeout(() => {
                    alert(`å·²è¼‰å…¥ ${newRestaurants.length} é–“æ–°é¤å»³ï¼`);
                    // é‡æ–°é–‹å§‹è½‰ç›¤
                    showWheelModal();
                }, 100);
                
            } catch (error) {
                hideLoading();
                showError('è¼‰å…¥æ–°é¤å»³æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š' + error.message);
            }
        }

        // ============================================
        // é é¢è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–
        // ============================================
        
        window.addEventListener('load', init);
    </script>

</body>
</html>