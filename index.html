<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>120 åˆ†é˜ç¾å‘³é›·é” ğŸœ</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Maps API with Places Library -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA-W47DliyOJbMn9NXfFQbzMJ39yVWjz-c&libraries=places"></script>
    <style>
        /* è‡ªè¨‚æ¨£å¼ - è®“æœå°‹æ¡†èˆ‡ Google Places Autocomplete æ•´åˆæ›´å¥½çœ‹ */
        .pac-container {
            border-radius: 0.5rem;
            margin-top: 0.25rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        
        /* æ˜Ÿæ˜Ÿåœ–ç¤º */
        .star {
            color: #f59e0b;
        }
        
        /* Loading å‹•ç•« */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .spinner {
            animation: spin 1s linear infinite;
        }
        
        /* å¹³æ»‘æ»¾å‹• */
        html {
            scroll-behavior: smooth;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-amber-50 to-orange-100 min-h-screen">
    
    <!-- ä¸»å®¹å™¨ -->
    <div class="container mx-auto px-4 py-6 md:py-10 max-w-7xl">
        
        <!-- æ¨™é¡Œå€åŸŸ -->
        <header class="text-center mb-8 md:mb-12">
            <h1 class="text-4xl md:text-5xl lg:text-6xl font-bold text-orange-600 mb-3">
                ğŸœ é£¢é¤“é£Ÿåˆ»
            </h1>
        </header>

        <!-- æœå°‹æ§åˆ¶å€åŸŸ -->
        <div class="bg-white rounded-2xl shadow-xl p-6 md:p-8 mb-8">
            
            <!-- Mobile: å‚ç›´å †ç–Š / Desktop: æ°´å¹³æ’åˆ— -->
            <div class="flex flex-col md:flex-row md:items-end gap-4 md:gap-6">
                
                <!-- ä½ç½®æœå°‹æ¡† -->
                <div class="flex-1">
                    <label for="location-input" class="block text-sm font-semibold text-orange-900 mb-2">
                        ğŸ“ è«‹è¼¸å…¥åœ°é»
                    </label>
                    <input 
                        type="text" 
                        id="location-input" 
                        placeholder="ä¾‹å¦‚ï¼šå°åŒ— 101" 
                        class="w-full px-4 py-3 border-2 border-orange-300 rounded-lg focus:outline-none focus:border-orange-500 focus:ring-2 focus:ring-orange-200 transition-all"
                    />
                </div>

                <!-- æœ€ä½è©•åˆ†æ»‘æ¡¿ -->
                <div class="flex-1">
                    <label for="rating-slider" class="block text-sm font-semibold text-orange-900 mb-2">
                        â­ æœ€ä½è©•åˆ†: <span id="rating-value" class="text-orange-600">4.0</span>
                    </label>
                    <input 
                        type="range" 
                        id="rating-slider" 
                        min="0" 
                        max="5" 
                        step="0.5" 
                        value="4.0" 
                        class="w-full h-2 bg-orange-200 rounded-lg appearance-none cursor-pointer accent-orange-500"
                    />
                </div>

                <!-- åƒ¹æ ¼ç­‰ç´šé¸æ“‡ -->
                <div class="flex-1">
                    <label class="block text-sm font-semibold text-orange-900 mb-2">
                        ğŸ’° åƒ¹æ ¼ç­‰ç´š
                    </label>
                    <div class="flex gap-2">
                        <button class="price-btn flex-1 px-3 py-2 border-2 border-orange-300 rounded-lg text-orange-800 hover:bg-orange-100 transition-colors" data-price="1">$</button>
                        <button class="price-btn flex-1 px-3 py-2 border-2 border-orange-300 rounded-lg text-orange-800 hover:bg-orange-100 transition-colors" data-price="2">$$</button>
                        <button class="price-btn flex-1 px-3 py-2 border-2 border-orange-300 rounded-lg text-orange-800 hover:bg-orange-100 transition-colors" data-price="3">$$$</button>
                        <button class="price-btn flex-1 px-3 py-2 border-2 border-orange-300 rounded-lg text-orange-800 hover:bg-orange-100 transition-colors" data-price="4">$$$$</button>
                    </div>
                </div>

                <!-- æœå°‹æŒ‰éˆ• -->
                <div class="md:flex-none">
                    <button 
                        id="search-btn" 
                        class="w-full md:w-auto px-8 py-3 bg-gradient-to-r from-orange-500 to-red-500 text-white font-bold rounded-lg shadow-lg hover:from-orange-600 hover:to-red-600 transform hover:scale-105 transition-all duration-200"
                    >
                        ğŸ” æœå°‹ç¾é£Ÿ
                    </button>
                </div>
            </div>
        </div>

        <!-- Loading ç‹€æ…‹ -->
        <div id="loading" class="hidden text-center py-12">
            <div class="inline-block w-16 h-16 border-4 border-orange-300 border-t-orange-600 rounded-full spinner"></div>
            <p class="mt-4 text-orange-700 font-semibold">æ­£åœ¨æœå°‹é™„è¿‘çš„ç¾å‘³é¤å»³...</p>
        </div>

        <!-- éŒ¯èª¤è¨Šæ¯ -->
        <div id="error-message" class="hidden bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-lg mb-6">
            <p class="font-bold">âš ï¸ ç™¼ç”ŸéŒ¯èª¤</p>
            <p id="error-text"></p>
        </div>

        <!-- çµæœå€åŸŸ -->
        <div id="results" class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- å‹•æ…‹ç”Ÿæˆçš„é¤å»³å¡ç‰‡å°‡é¡¯ç¤ºåœ¨é€™è£¡ -->
        </div>

        <!-- ç„¡çµæœæç¤º -->
        <div id="no-results" class="hidden text-center py-12">
            <div class="text-6xl mb-4">ğŸ˜¢</div>
            <p class="text-xl text-orange-700 font-semibold">æŠ±æ­‰ï¼Œæ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„é¤å»³</p>
            <p class="text-orange-600 mt-2">è«‹å˜—è©¦èª¿æ•´æœå°‹æ¢ä»¶æˆ–æ›´æ›åœ°é»</p>
        </div>
    </div>

    <script>
        // ============================================
        // å…¨åŸŸè®Šæ•¸èˆ‡ç‹€æ…‹ç®¡ç†
        // ============================================
        
        let autocomplete; // Google Places Autocomplete å¯¦ä¾‹
        let selectedLocation = null; // ä½¿ç”¨è€…é¸æ“‡çš„ä½ç½®
        let selectedPriceLevels = [1, 2, 3, 4]; // é è¨­é¸æ“‡æ‰€æœ‰åƒ¹æ ¼ç­‰ç´š
        let map; // Google Map å¯¦ä¾‹ï¼ˆéš±è—ï¼Œåƒ…ç”¨æ–¼æœå‹™ï¼‰
        let placesService; // Places Service å¯¦ä¾‹

        // ============================================
        // åˆå§‹åŒ–å‡½å¼
        // ============================================
        
        function init() {
            // åˆå§‹åŒ– Google Places Autocomplete
            const input = document.getElementById('location-input');
            autocomplete = new google.maps.places.Autocomplete(input, {
                types: ['geocode', 'establishment']
            });
            
            // ç›£è½åœ°é»é¸æ“‡äº‹ä»¶
            autocomplete.addListener('place_changed', onPlaceChanged);
            
            // åˆå§‹åŒ–éš±è—çš„åœ°åœ–ï¼ˆç”¨æ–¼ PlacesServiceï¼‰
            map = new google.maps.Map(document.createElement('div'));
            placesService = new google.maps.places.PlacesService(map);
            
            // ç¶å®šè©•åˆ†æ»‘æ¡¿äº‹ä»¶
            const ratingSlider = document.getElementById('rating-slider');
            ratingSlider.addEventListener('input', (e) => {
                document.getElementById('rating-value').textContent = e.target.value;
            });
            
            // ç¶å®šåƒ¹æ ¼æŒ‰éˆ•äº‹ä»¶
            const priceBtns = document.querySelectorAll('.price-btn');
            priceBtns.forEach(btn => {
                btn.addEventListener('click', togglePriceLevel);
            });
            
            // é è¨­é¸ä¸­æ‰€æœ‰åƒ¹æ ¼ç­‰ç´š
            priceBtns.forEach(btn => btn.classList.add('bg-orange-500', 'text-white', 'border-orange-500'));
            
            // ç¶å®šæœå°‹æŒ‰éˆ•äº‹ä»¶
            document.getElementById('search-btn').addEventListener('click', searchRestaurants);
        }

        // ============================================
        // åœ°é»é¸æ“‡è™•ç†
        // ============================================
        
        function onPlaceChanged() {
            const place = autocomplete.getPlace();
            if (!place.geometry || !place.geometry.location) {
                showError('è«‹é¸æ“‡ä¸€å€‹æœ‰æ•ˆçš„åœ°é»');
                return;
            }
            selectedLocation = {
                lat: place.geometry.location.lat(),
                lng: place.geometry.location.lng(),
                name: place.name || place.formatted_address
            };
        }

        // ============================================
        // åƒ¹æ ¼ç­‰ç´šåˆ‡æ›
        // ============================================
        
        function togglePriceLevel(e) {
            const btn = e.target;
            const price = parseInt(btn.dataset.price);
            
            if (btn.classList.contains('bg-orange-500')) {
                // å–æ¶ˆé¸æ“‡
                btn.classList.remove('bg-orange-500', 'text-white', 'border-orange-500');
                btn.classList.add('border-orange-300', 'text-orange-800');
                selectedPriceLevels = selectedPriceLevels.filter(p => p !== price);
            } else {
                // é¸æ“‡
                btn.classList.add('bg-orange-500', 'text-white', 'border-orange-500');
                btn.classList.remove('border-orange-300', 'text-orange-800');
                selectedPriceLevels.push(price);
            }
        }

        // ============================================
        // ä¸»æœå°‹å‡½å¼
        // ============================================
        
        async function searchRestaurants() {
            // é©—è­‰è¼¸å…¥
            if (!selectedLocation) {
                showError('è«‹å…ˆé¸æ“‡ä¸€å€‹åœ°é»');
                return;
            }
            
            if (selectedPriceLevels.length === 0) {
                showError('è«‹è‡³å°‘é¸æ“‡ä¸€å€‹åƒ¹æ ¼ç­‰ç´š');
                return;
            }
            
            // å–å¾—æœ€ä½è©•åˆ†
            const minRating = parseFloat(document.getElementById('rating-slider').value);
            
            // é¡¯ç¤º Loading ç‹€æ…‹
            showLoading();
            hideError();
            clearResults();
            
            try {
                // æ­¥é©Ÿ 1: ä½¿ç”¨ nearbySearch æœå°‹é¤å»³
                const nearbyResults = await searchNearbyRestaurants(selectedLocation, minRating);
                
                // æ­¥é©Ÿ 2: éæ¿¾åƒ¹æ ¼ç­‰ç´š
                const filteredByPrice = nearbyResults.filter(place => 
                    !place.price_level || selectedPriceLevels.includes(place.price_level)
                );
                
                // æ­¥é©Ÿ 3: æŒ‰è©•åˆ†æ’åºï¼Œå–å‰ 15 ç­†
                const top15 = filteredByPrice
                    .sort((a, b) => (b.rating || 0) - (a.rating || 0))
                    .slice(0, 15);
                
                // æ­¥é©Ÿ 4: å°å‰ 15 ç­†é€²è¡Œè©³ç´°è³‡è¨ŠæŸ¥è©¢ï¼ˆåŒ…å«ç‡Ÿæ¥­æ™‚é–“ï¼‰
                const detailedResults = await Promise.all(
                    top15.map(place => getPlaceDetails(place.place_id))
                );
                
                // æ­¥é©Ÿ 5: éæ¿¾å‡ºã€Œ120 åˆ†é˜å¾Œä»ç‡Ÿæ¥­ã€çš„é¤å»³
                const openIn120Min = detailedResults.filter(place => 
                    isOpenIn120Minutes(place)
                );
                
                // æ­¥é©Ÿ 6: æŒ‰è©•åˆ†æ’åºï¼Œå–å‰ 10 ç­†
                const top10 = openIn120Min
                    .sort((a, b) => (b.rating || 0) - (a.rating || 0))
                    .slice(0, 10);
                
                // é¡¯ç¤ºçµæœ
                hideLoading();
                displayResults(top10);
                
            } catch (error) {
                hideLoading();
                showError('æœå°‹æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š' + error.message);
            }
        }

        // ============================================
        // Google Places API å‘¼å«
        // ============================================
        
        /**
         * ä½¿ç”¨ nearbySearch æœå°‹é™„è¿‘é¤å»³
         */
        function searchNearbyRestaurants(location, minRating) {
            return new Promise((resolve, reject) => {
                const request = {
                    location: new google.maps.LatLng(location.lat, location.lng),
                    radius: 2000, // 2000 å…¬å°º
                    type: 'restaurant'
                };
                
                placesService.nearbySearch(request, (results, status) => {
                    if (status === google.maps.places.PlacesServiceStatus.OK) {
                        // éæ¿¾è©•åˆ†
                        const filtered = results.filter(place => 
                            place.rating && place.rating >= minRating
                        );
                        resolve(filtered);
                    } else {
                        reject(new Error('æœå°‹å¤±æ•—ï¼š' + status));
                    }
                });
            });
        }

        /**
         * å–å¾—é¤å»³è©³ç´°è³‡è¨Šï¼ˆåŒ…å«ç‡Ÿæ¥­æ™‚é–“ï¼‰
         */
        function getPlaceDetails(placeId) {
            return new Promise((resolve, reject) => {
                const request = {
                    placeId: placeId,
                    fields: ['name', 'rating', 'user_ratings_total', 'price_level', 'opening_hours', 'vicinity', 'place_id']
                };
                
                placesService.getDetails(request, (place, status) => {
                    if (status === google.maps.places.PlacesServiceStatus.OK) {
                        resolve(place);
                    } else {
                        // å¦‚æœå–®ä¸€é¤å»³æŸ¥è©¢å¤±æ•—ï¼Œè¿”å› null è€Œéæ‹’çµ•
                        resolve(null);
                    }
                });
            });
        }

        // ============================================
        // 120 åˆ†é˜ç‡Ÿæ¥­é‚è¼¯åˆ¤æ–·
        // ============================================
        
        /**
         * åˆ¤æ–·é¤å»³åœ¨ã€Œç•¶å‰æ™‚é–“ + 120 åˆ†é˜ã€æ˜¯å¦ç‡Ÿæ¥­
         */
        function isOpenIn120Minutes(place) {
            // å¦‚æœæ²’æœ‰ç‡Ÿæ¥­æ™‚é–“è³‡è¨Šï¼Œé è¨­ç‚ºä¸ç¬¦åˆï¼ˆä¿å®ˆåšæ³•ï¼‰
            if (!place || !place.opening_hours || !place.opening_hours.periods) {
                return false;
            }
            
            // è¨ˆç®—ç›®æ¨™æ™‚é–“ï¼ˆç•¶å‰æ™‚é–“ + 120 åˆ†é˜ï¼‰
            const now = new Date();
            const targetTime = new Date(now.getTime() + 120 * 60 * 1000);
            const targetDay = targetTime.getDay(); // 0 = Sunday, 1 = Monday, ..., 6 = Saturday
            const targetMinutes = targetTime.getHours() * 60 + targetTime.getMinutes();
            
            // æª¢æŸ¥è©²æ™‚æ®µæ˜¯å¦ç‡Ÿæ¥­
            const periods = place.opening_hours.periods;
            
            for (let period of periods) {
                const openDay = period.open.day;
                const openTime = period.open.hours * 60 + period.open.minutes;
                
                // è™•ç† 24 å°æ™‚ç‡Ÿæ¥­çš„æƒ…æ³
                if (!period.close) {
                    return true;
                }
                
                const closeDay = period.close.day;
                const closeTime = period.close.hours * 60 + period.close.minutes;
                
                // æƒ…æ³ 1: æœªè·¨æ—¥ï¼ˆopen å’Œ close åœ¨åŒä¸€å¤©ï¼‰
                if (openDay === closeDay) {
                    if (targetDay === openDay && targetMinutes >= openTime && targetMinutes < closeTime) {
                        return true;
                    }
                }
                // æƒ…æ³ 2: è·¨æ—¥ï¼ˆä¾‹å¦‚é€±äº” 22:00 ~ é€±å…­ 02:00ï¼‰
                else {
                    // æª¢æŸ¥æ˜¯å¦åœ¨é–‹å§‹æ—¥æœŸçš„ç‡Ÿæ¥­æ™‚é–“å…§
                    if (targetDay === openDay && targetMinutes >= openTime) {
                        return true;
                    }
                    // æª¢æŸ¥æ˜¯å¦åœ¨çµæŸæ—¥æœŸçš„ç‡Ÿæ¥­æ™‚é–“å…§
                    if (targetDay === closeDay && targetMinutes < closeTime) {
                        return true;
                    }
                }
            }
            
            return false;
        }

        // ============================================
        // UI æ›´æ–°å‡½å¼
        // ============================================
        
        /**
         * é¡¯ç¤ºæœå°‹çµæœ
         */
        function displayResults(restaurants) {
            const resultsContainer = document.getElementById('results');
            const noResults = document.getElementById('no-results');
            
            if (restaurants.length === 0) {
                noResults.classList.remove('hidden');
                return;
            }
            
            noResults.classList.add('hidden');
            
            restaurants.forEach(restaurant => {
                const card = createRestaurantCard(restaurant);
                resultsContainer.appendChild(card);
            });
        }

        /**
         * å»ºç«‹é¤å»³å¡ç‰‡
         */
        function createRestaurantCard(restaurant) {
            const card = document.createElement('div');
            card.className = 'bg-white rounded-xl shadow-lg overflow-hidden hover:shadow-2xl transition-shadow duration-300';
            
            // åƒ¹æ ¼ç­‰ç´šé¡¯ç¤º
            const priceDisplay = '$'.repeat(restaurant.price_level || 1);
            
            // æ˜Ÿæ˜Ÿè©•åˆ†
            const stars = generateStars(restaurant.rating || 0);
            
            // ç‡Ÿæ¥­ç‹€æ…‹æ¨™ç±¤
            const statusBadge = '<span class="inline-block px-3 py-1 bg-green-500 text-white text-xs font-semibold rounded-full">âœ“ 120åˆ†é˜å…§ç‡Ÿæ¥­</span>';
            
            card.innerHTML = `
                <div class="p-6">
                    <!-- åº—å -->
                    <h3 class="text-xl font-bold text-orange-900 mb-2 line-clamp-1">
                        ${restaurant.name}
                    </h3>
                    
                    <!-- è©•åˆ†èˆ‡è©•è«–æ•¸ -->
                    <div class="flex items-center gap-2 mb-3">
                        <div class="flex items-center">
                            ${stars}
                            <span class="ml-2 text-lg font-semibold text-orange-700">${restaurant.rating || 'N/A'}</span>
                        </div>
                        <span class="text-gray-500 text-sm">(${restaurant.user_ratings_total || 0} å‰‡è©•è«–)</span>
                    </div>
                    
                    <!-- åƒ¹æ ¼ç­‰ç´š -->
                    <div class="mb-3">
                        <span class="text-orange-600 font-bold text-lg">${priceDisplay}</span>
                    </div>
                    
                    <!-- åœ°å€ -->
                    <p class="text-gray-600 text-sm mb-4 line-clamp-2">
                        ğŸ“ ${restaurant.vicinity || 'åœ°å€è³‡è¨Šä¸å¯ç”¨'}
                    </p>
                    
                    <!-- ç‡Ÿæ¥­ç‹€æ…‹æ¨™ç±¤ -->
                    <div class="mb-4">
                        ${statusBadge}
                    </div>
                    
                    <!-- Google Maps é€£çµ -->
                    <a 
                        href="https://www.google.com/maps/place/?q=place_id:${restaurant.place_id}" 
                        target="_blank" 
                        class="inline-block w-full text-center px-4 py-2 bg-orange-500 text-white font-semibold rounded-lg hover:bg-orange-600 transition-colors"
                    >
                        åœ¨ Google Maps ä¸­æŸ¥çœ‹
                    </a>
                </div>
            `;
            
            return card;
        }

        /**
         * ç”Ÿæˆæ˜Ÿæ˜Ÿè©•åˆ† HTML
         */
        function generateStars(rating) {
            const fullStars = Math.floor(rating);
            const hasHalfStar = rating % 1 >= 0.5;
            let starsHTML = '';
            
            for (let i = 0; i < fullStars; i++) {
                starsHTML += '<span class="star">â˜…</span>';
            }
            
            if (hasHalfStar) {
                starsHTML += '<span class="star">â¯¨</span>';
            }
            
            const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);
            for (let i = 0; i < emptyStars; i++) {
                starsHTML += '<span class="text-gray-300">â˜…</span>';
            }
            
            return starsHTML;
        }

        /**
         * é¡¯ç¤º Loading ç‹€æ…‹
         */
        function showLoading() {
            document.getElementById('loading').classList.remove('hidden');
        }

        /**
         * éš±è— Loading ç‹€æ…‹
         */
        function hideLoading() {
            document.getElementById('loading').classList.add('hidden');
        }

        /**
         * é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
         */
        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            const errorText = document.getElementById('error-text');
            errorText.textContent = message;
            errorDiv.classList.remove('hidden');
        }

        /**
         * éš±è—éŒ¯èª¤è¨Šæ¯
         */
        function hideError() {
            document.getElementById('error-message').classList.add('hidden');
        }

        /**
         * æ¸…ç©ºæœå°‹çµæœ
         */
        function clearResults() {
            document.getElementById('results').innerHTML = '';
            document.getElementById('no-results').classList.add('hidden');
        }

        // ============================================
        // é é¢è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–
        // ============================================
        
        window.addEventListener('load', init);
    </script>

</body>
</html>